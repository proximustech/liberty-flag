<script>
    app.md.flag_form={}
    app.md.flag_form.prefix=<%- JSON.stringify(prefix) %>
    app.md.flag_form.flag=JSON.parse(`<%- JSON.stringify(flag) %>`)
    app.md.flag_form.flagValidateSchema = JSON.parse(`<%- JSON.stringify(flagValidateSchema).replaceAll("\\","\\\\") %>`)
    eval(`<%- flagValidateFunction %>`)

    app.md.flag_form.userPermissions = JSON.parse(`<%- JSON.stringify(userPermissions) %>`)
    eval(`<%- userHasPermissionOnElement %>`)    

    app.md.flag_form.flagContext=JSON.parse(`<%- JSON.stringify(flagContext) %>`)
    //app.md.flag_form.engineBoolean=JSON.parse(`<%- //JSON.stringify(engineBoolean) %>`)

    app.md.flag_form.engineBooleanConditioned=JSON.parse(`<%- JSON.stringify(engineBooleanConditioned) %>`)
    app.md.flag_form.engineBooleanConditionedCondition=JSON.parse(`<%- JSON.stringify(engineBooleanConditionedCondition) %>`)
    app.md.flag_form.engineBooleanConditionedConditionValidateShema = JSON.parse(`<%- JSON.stringify(engineBooleanConditionedConditionValidateShema).replaceAll("\\","\\\\") %>`)    
    eval(`<%- engineBooleanConditionedConditionValidateFunction %>`)

    app.md.flag_form.bucket=JSON.parse(`<%- JSON.stringify(bucket) %>`)
    app.md.flag_form.bucket_context_uuid=`<%= bucketContextUuid %>`

    function submitFlag(triggerElement) {

        let tags=[]

        for(let i=0 ;i<document.getElementById("flag_tags").selectedOptions.length;i++){
            tags.push(document.getElementById("flag_tags").selectedOptions[i].value)
        }
        
        app.md.flag_form.flag.tags=tags

        let flag = app.md.flag_form.flag
        flag.name = flag.name.trim()
        let flagValidationResult = app.md.flag_form.flagValidateFunction(flag,app.md.flag_form.flagValidateSchema)
       
        if (flagValidationResult.isValid) {
            app.setElementForPendingOperation(triggerElement)
            let result = $.ajax({
                type:"POST",
                url:"<%= prefix %>/flag",
                data:"json="+JSON.stringify(flag),
                processData: false,
                dataType:"text"
            })
            .done(function() {
                setTimeout(() => {
                    app.reloadLastBreadCrumb('content_view')
                    app.drawer.hide();
                    app.toastShow('Saved','Flag saved successfully.',{type:"info"})           
                    
                }, 1000);
            })
            .fail(function(data) {
                try {
                    app.unsetElementForPendingOperation(triggerElement)
                    for (messageData of JSON.parse(data.responseText).messages) {
                        app.toastShow('Form data Error',messageData.message,{type:"error"})
                        break;
                    }

                } catch (error) {}
            })
            .always(function() {
            });              
        } else {
            try {
                app.toastShow('Form data Error',flagValidationResult.messages[0].message,{closable:true,type:"error"})
            } catch (error) {}
        }

      
    }

    function deleteFlag(uuid) {
        let result = $.ajax({
            type:"DELETE",
            url:"<%= prefix %>/flag?uuid="+uuid,
        })
        .done(function() {      
            setTimeout(() =>{
                app.reloadLastBreadCrumb('content_view')
                app.drawer.hide();
                app.dialog.hide()
                app.toastShow('Deleted','Flag deleted successfully.',{type:"info"}) 
            },1000)   
        })
    
    }

    function getFlagContextIndexByUuId(contextUuid){
        found = false
        for (let index = 0; index < app.md.flag_form.flag.contexts.length; index++) {
            if( app.md.flag_form.flag.contexts[index].bucket_context_uuid===contextUuid){
                found = index
            }
        }
        return found
    }
    function getBucketContextByUuId(contextUuid){
        found = {}
        for (let index = 0; index < app.md.flag_form.bucket.contexts.length; index++) {
            if( app.md.flag_form.bucket.contexts[index].uuid===contextUuid){
                found = app.md.flag_form.bucket.contexts[index]
            }
        }
        return found
    }

    /**
     * Redraws ALL the contexts of the "Context Values Tab"
     */
    function addFlagContextsToList(){
        document.getElementById('contexts_values_config').innerHTML=""
        let counter = 0
        app.md.flag_form.flag.contexts.forEach(flagContext => {
            addFlagContextToList(getBucketContextByUuId(flagContext.bucket_context_uuid),counter)
            counter++
        });
    }

    /**
     * Renders a specific context in the "Context Values" Tab
     */
    function addFlagContextToList(bucketContext,counter) {
        let booleanIsSelected = ""
        let booleanConditionedTrueIsSelected = ""
        let booleanConditionedFalseIsSelected = ""
        let booleanConditionedOrTrueIsSelected = ""
        let booleanConditionedOrFalseIsSelected = ""
        let stringIsSelected = ""

        if (app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine==="boolean") {
            booleanIsSelected="selected"
        } else if(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine==="boolean_conditioned_true") {
            booleanConditionedTrueIsSelected = "selected"
        } else if(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine==="boolean_conditioned_false") {
            booleanConditionedFalseIsSelected = "selected"
        } else if(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine==="boolean_conditionedor_true") {
            booleanConditionedOrTrueIsSelected = "selected"
        } else if(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine==="boolean_conditionedor_false") {
            booleanConditionedOrFalseIsSelected = "selected"
        } else if(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine==="string") {
            stringIsSelected = "selected"
        }

        let disabled = "disabled='disabled'"
        if (app.md.flag_form.userHasPermissionOnElement(app.md.flag_form.userPermissions,[app.md.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }

        document.getElementById('contexts_values_config').insertAdjacentHTML("beforeend",`
            <div id="context_${bucketContext.uuid}_wrapper" style="margin-bottom: 10px;">
                <sl-details id='bucket_context_value_config_${bucketContext.uuid}' summary="${bucketContext.name}">
                    <label style='margin-bottom:7px;font-size:17px'>Engine</label>
                    <select style="width:100%;margin-bottom:7px" onchange="setEngineView(this.value,'${bucketContext.uuid}')" ${disabled}>
                        <option value="boolean" ${booleanIsSelected}>True/False</option>
                        <option value="boolean_conditioned_true" ${booleanConditionedTrueIsSelected} >True (AND)</option>
                        <option value="boolean_conditioned_false" ${booleanConditionedFalseIsSelected} >False (AND)</option>
                        <option value="boolean_conditionedor_true" ${booleanConditionedOrTrueIsSelected} >True (OR)</option>
                        <option value="boolean_conditionedor_false" ${booleanConditionedOrFalseIsSelected} >False (OR)</option>
                        <option value="string" ${stringIsSelected} >String</option>
                    </select> 
                    <div id="engine_container_${bucketContext.uuid}" style="padding:5px"></div>
                </sl-details>
            </div>
            `)
        setEngineView(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine,`${bucketContext.uuid}`)
    }

    /**
     * Set display context data inside the "Context Values Tab" and Sets the data inside the flag data structure
     */ 
    function setFlagContextValueConfig(contextUuid){
        let isChecked = document.getElementById("bucket_context_visibility_"+contextUuid).checked

        if (isChecked) {
            let newFlagContext = JSON.parse(JSON.stringify(app.md.flag_form.flagContext))
            newFlagContext.bucket_context_uuid = contextUuid

            newFlagContext.engine="boolean"
            newFlagContext.engine_parameters.boolean={status:false}

            newFlagContext.engine_parameters.boolean_conditioned_true={conditions:[]}
            newFlagContext.engine_parameters.boolean_conditioned_false={conditions:[]}
            newFlagContext.engine_parameters.boolean_conditionedor_true={conditions:[]}
            newFlagContext.engine_parameters.boolean_conditionedor_false={conditions:[]}
            newFlagContext.engine_parameters.string={value:"",configuration:""}

            app.md.flag_form.flag.contexts.push(newFlagContext)

            addFlagContextsToList()


        } else {
            //Remove flag context from the Values list
            app.md.flag_form.flag.contexts.splice(getFlagContextIndexByUuId(contextUuid), 1);
            document.getElementById('contexts_values_config').removeChild(
                document.getElementById(`context_${contextUuid}_wrapper`)
            )
            
        }

    }

    /**
     * Saves a condition (conditionedTrue engine) data inside the flag data structure and sets the listeners for validation
     */
    function setEngineBooleanConditionatedTrueConditionValueConfig(contextUuid,conditionNumber){
        
        let firstParameterElement=document.getElementById(`engine_boolean_conditioned_true_first_parameter_${contextUuid}_${conditionNumber}`)
        let secondParameterElement=document.getElementById(`engine_boolean_conditioned_true_second_parameter_${contextUuid}_${conditionNumber}`)
        let operatorParameterElement=document.getElementById(`engine_boolean_conditioned_true_operator_parameter_${contextUuid}_${conditionNumber}`)

        let condition = JSON.parse(JSON.stringify(app.md.flag_form.engineBooleanConditionedCondition))
        condition.first_parameter=firstParameterElement.value
        condition.second_parameter=secondParameterElement.value
        condition.operator_parameter=operatorParameterElement.value

        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions[conditionNumber]=condition
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,firstParameterElement.id,app.md.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,secondParameterElement.id,app.md.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
        
    }

    /**
     * Saves a condition (conditionedFalse engine) data inside the flag data structure and sets the listeners for validation
     */    
    function setEngineBooleanConditionatedFalseConditionValueConfig(contextUuid,conditionNumber){
        
        let firstParameterElement=document.getElementById(`engine_boolean_conditioned_false_first_parameter_${contextUuid}_${conditionNumber}`)
        let secondParameterElement=document.getElementById(`engine_boolean_conditioned_false_second_parameter_${contextUuid}_${conditionNumber}`)
        let operatorParameterElement=document.getElementById(`engine_boolean_conditioned_false_operator_parameter_${contextUuid}_${conditionNumber}`)

        let condition = JSON.parse(JSON.stringify(app.md.flag_form.engineBooleanConditionedCondition))
        condition.first_parameter=firstParameterElement.value
        condition.second_parameter=secondParameterElement.value
        condition.operator_parameter=operatorParameterElement.value

        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions[conditionNumber]=condition
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,firstParameterElement.id,app.md.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,secondParameterElement.id,app.md.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
        
    }   

    /**
     * Saves a condition (conditionedTrue (OR) engine) data inside the flag data structure and sets the listeners for validation
     */
    function setEngineBooleanConditionatedOrTrueConditionValueConfig(contextUuid,conditionNumber){
        
        let firstParameterElement=document.getElementById(`engine_boolean_conditionedor_true_first_parameter_${contextUuid}_${conditionNumber}`)
        let secondParameterElement=document.getElementById(`engine_boolean_conditionedor_true_second_parameter_${contextUuid}_${conditionNumber}`)
        let operatorParameterElement=document.getElementById(`engine_boolean_conditionedor_true_operator_parameter_${contextUuid}_${conditionNumber}`)

        let condition = JSON.parse(JSON.stringify(app.md.flag_form.engineBooleanConditionedCondition))
        condition.first_parameter=firstParameterElement.value
        condition.second_parameter=secondParameterElement.value
        condition.operator_parameter=operatorParameterElement.value

        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_true.conditions[conditionNumber]=condition
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,firstParameterElement.id,app.md.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,secondParameterElement.id,app.md.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
        
    } 

    /**
     * Saves a condition (conditionedFalse (OR) engine) data inside the flag data structure and sets the listeners for validation
     */
     function setEngineBooleanConditionatedOrFalseConditionValueConfig(contextUuid,conditionNumber){

        let firstParameterElement=document.getElementById(`engine_boolean_conditionedor_false_first_parameter_${contextUuid}_${conditionNumber}`)
        let secondParameterElement=document.getElementById(`engine_boolean_conditionedor_false_second_parameter_${contextUuid}_${conditionNumber}`)
        let operatorParameterElement=document.getElementById(`engine_boolean_conditionedor_false_operator_parameter_${contextUuid}_${conditionNumber}`)

        let condition = JSON.parse(JSON.stringify(app.md.flag_form.engineBooleanConditionedCondition))
        condition.first_parameter=firstParameterElement.value
        condition.second_parameter=secondParameterElement.value
        condition.operator_parameter=operatorParameterElement.value

        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_false.conditions[conditionNumber]=condition
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,firstParameterElement.id,app.md.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,secondParameterElement.id,app.md.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
        
    }     

    /**
     * Renders the html template for the selected engine and updates the flag data structure
     */
    function setEngineView(engine,contextUuid){

        let disabled = "disabled='disabled'"
        if (app.md.flag_form.userHasPermissionOnElement(app.md.flag_form.userPermissions,[app.md.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }

        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine=engine
        if (engine === "boolean") {

            let checked = ""
            if(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean.status){
                checked = "checked"
            }
            document.getElementById('engine_container_'+contextUuid).innerHTML = `
            <div class="form-check form-switch">
                <label class="form-check-label" for="flexCheckChecked">
                    Boolean Status
                </label>
                <input class="form-check-input" type="checkbox" role="switch" style="font-size:large" ${checked} onchange="app.md.flag_form.flag.contexts[getFlagContextIndexByUuId('${contextUuid}')].engine_parameters.boolean={status:this.checked}" ${disabled}>
            </div>
            `
        } else if (engine === "boolean_conditioned_true" ) {
            document.getElementById('engine_container_'+contextUuid).innerHTML = `
                <button type="button" class="btn btn-outline-primary" style="width:100%" onclick="addEngineBooleanConditionedTrueCondition('${contextUuid}')" ${disabled}><i class="bi bi-plus-circle"></i> Add Condition</button>
                <div id='boolean_conditioned_true_conditions_${contextUuid}'></div>
            `  
            for (let index = 0; index < app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions.length; index++) {
                addEngineBooleanConditionedTrueCondition(contextUuid,app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions[index])
                
            }        
        }
        else if (engine === "boolean_conditioned_false" ) {
            document.getElementById('engine_container_'+contextUuid).innerHTML = `
                <button type="button" class="btn btn-outline-primary" style="width:100%" onclick="addEngineBooleanConditionedFalseCondition('${contextUuid}')" ${disabled}><i class="bi bi-plus-circle"></i> Add Condition</button>
                <div id='boolean_conditioned_false_conditions_${contextUuid}'></div>
            `  
            for (let index = 0; index < app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions.length; index++) {
                addEngineBooleanConditionedFalseCondition(contextUuid,app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions[index])
                
            }        
        } else if (engine === "boolean_conditionedor_true" ) {
            document.getElementById('engine_container_'+contextUuid).innerHTML = `
                <button type="button" class="btn btn-outline-primary" style="width:100%" onclick="addEngineBooleanConditionedOrTrueCondition('${contextUuid}')" ${disabled}><i class="bi bi-plus-circle"></i> Add Condition</button>
                <div id='boolean_conditionedor_true_conditions_${contextUuid}'></div>
            `  
            for (let index = 0; index < app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_true.conditions.length; index++) {
                addEngineBooleanConditionedOrTrueCondition(contextUuid,app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_true.conditions[index])
                
            }        
        } else if (engine === "boolean_conditionedor_false" ) {
            document.getElementById('engine_container_'+contextUuid).innerHTML = `
                <button type="button" class="btn btn-outline-primary" style="width:100%" onclick="addEngineBooleanConditionedOrFalseCondition('${contextUuid}')" ${disabled}><i class="bi bi-plus-circle"></i> Add Condition</button>
                <div id='boolean_conditionedor_false_conditions_${contextUuid}'></div>
            `  
            for (let index = 0; index < app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_false.conditions.length; index++) {
                addEngineBooleanConditionedOrFalseCondition(contextUuid,app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_false.conditions[index])
                
            }        
        } else if (engine === "string" ) {
            let stringValue = app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.string.value
            let stringValueConfiguration = app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.string.configuration
            document.getElementById('engine_container_'+contextUuid).innerHTML = `
                <label style='margin-bottom:4px'>Select an option from the list</label>
                <select id="string_engine_value_selection_${contextUuid}" style="width:100%;margin-bottom:7px" onchange="app.md.flag_form.flag.contexts[getFlagContextIndexByUuId('${contextUuid}')].engine_parameters.string.value=this.value" ${disabled} >
                </select>
                <label style='margin-bottom:4px'>String Options Configuration</label>
                <input type='text' class='form-control' id='string_engine_value_config_${contextUuid}' value='${stringValueConfiguration}' onchange="setSelectOptionsForStringEngineConfiguration('${contextUuid}');app.md.flag_form.flag.contexts[getFlagContextIndexByUuId('${contextUuid}')].engine_parameters.string.configuration=this.value;app.md.flag_form.flag.contexts[getFlagContextIndexByUuId('${contextUuid}')].engine_parameters.string.value=''" ${disabled} placeholder='Separate the options with pipe |' />
            `
            setSelectOptionsForStringEngineConfiguration(contextUuid)     
        }
    }

    function setSelectOptionsForStringEngineConfiguration(contextUuid){
        let actualSelectedValue = app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.string.value
        let configurationSelect=document.getElementById(`string_engine_value_selection_${contextUuid}`)
        configurationSelect.innerHTML=`<option value=''>Select a value...</option>`
        let options = document.getElementById(`string_engine_value_config_${contextUuid}`).value.split('|')
        options.forEach(option => {
            option = option.trim()
            if (option!=="") {
                let selected = ""
                if (option===actualSelectedValue) {
                    selected="selected"
                }
                let optionsHtml = `
                    <option value='${option}' ${selected}>${option}</option>
                `
                configurationSelect.innerHTML+=optionsHtml
                
            }
        });
    }

    function addEngineBooleanConditionedTrueCondition(contextUuid,condition=JSON.parse(JSON.stringify(app.md.flag_form.engineBooleanConditionedCondition)) ){

        let disabled='disabled="disabled"'
        if (app.md.flag_form.userHasPermissionOnElement(app.md.flag_form.userPermissions,[app.md.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }

        //app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions
          
        let conditionsContainer = document.getElementById(`boolean_conditioned_true_conditions_${contextUuid}`)
        let newConditionNumber = conditionsContainer.childElementCount

        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions[newConditionNumber]=condition

        let selectedEqual = ""
        let selectedDifferent = ""
        let selectedLessThan = ""
        let selectedGreaterThan = ""

        if (condition.operator_parameter==="equal") {
            selectedEqual="selected"
        } else if(condition.operator_parameter==="different") {
            selectedDifferent="selected"
        } else if(condition.operator_parameter==="less_than") {
            selectedLessThan="selected"
        } else if(condition.operator_parameter==="greater_than") {
            selectedGreaterThan="selected"
        }

        let html =`
            <span id="boolean_condition_true_${contextUuid}_${newConditionNumber}" class="card" style="margin-top:10px;box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2)">
                <div class="card-body">
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteEngineBooleanConditionedTrueCondition('${contextUuid}',${newConditionNumber})" ${disabled}><i class="bi bi-dash-circle"></i></button> <label style='margin-bottom:7px;font-size:17px'>Condition #${newConditionNumber+1}</label>
                    <input id='engine_boolean_conditioned_true_first_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.first_parameter}' oninput="setEngineBooleanConditionatedTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Key' ${disabled} />
                    <label id='engine_boolean_conditioned_true_first_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
                    <select id="engine_boolean_conditioned_true_operator_parameter_${contextUuid}_${newConditionNumber}" class="js-example-basic-single" style="width:100%;margin-bottom:7px" onchange="setEngineBooleanConditionatedTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" ${disabled}>
                        <option value="equal" ${selectedEqual} > (=) Equal</option>
                        <option value="different" ${selectedDifferent} > (!=) Different</option>
                        <option value="less_than" ${selectedLessThan} > (<) Less than</option>
                        <option value="greater_than" ${selectedGreaterThan} > (>) Greater than</option>
                    </select>                        
                    <input id='engine_boolean_conditioned_true_second_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.second_parameter}' oninput="setEngineBooleanConditionatedTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Value' ${disabled} />
                    <label id='engine_boolean_conditioned_true_second_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>

                </div>
            </span>
        `
        conditionsContainer.insertAdjacentHTML('afterbegin',html)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditioned_true_first_parameter_${contextUuid}_${newConditionNumber}`,app.md.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditioned_true_second_parameter_${contextUuid}_${newConditionNumber}`,app.md.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
    }

    function addEngineBooleanConditionedFalseCondition(contextUuid,condition=JSON.parse(JSON.stringify(app.md.flag_form.engineBooleanConditionedCondition)) ){

        let disabled='disabled="disabled"'
        if (app.md.flag_form.userHasPermissionOnElement(app.md.flag_form.userPermissions,[app.md.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }

        //app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions
          
        let conditionsContainer = document.getElementById(`boolean_conditioned_false_conditions_${contextUuid}`)
        let newConditionNumber = conditionsContainer.childElementCount

        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions[newConditionNumber]=condition

        let selectedEqual = ""
        let selectedDifferent = ""
        let selectedLessThan = ""
        let selectedGreaterThan = ""

        if (condition.operator_parameter==="equal") {
            selectedEqual="selected"
        } else if(condition.operator_parameter==="different") {
            selectedDifferent="selected"
        } else if(condition.operator_parameter==="less_than") {
            selectedLessThan="selected"
        } else if(condition.operator_parameter==="greater_than") {
            selectedGreaterThan="selected"
        }

        let html =`
            <span id="boolean_condition_false_${contextUuid}_${newConditionNumber}" class="card" style="margin-top:10px;box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2)">
                <div class="card-body">        
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteEngineBooleanConditionedFalseCondition('${contextUuid}',${newConditionNumber})" ${disabled}><i class="bi bi-dash-circle"></i></button> <label style='margin-bottom:7px;font-size:17px'>Condition #${newConditionNumber+1}</label>
                    <input id='engine_boolean_conditioned_false_first_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.first_parameter}' oninput="setEngineBooleanConditionatedFalseConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Key' ${disabled} />
                    <label id='engine_boolean_conditioned_false_first_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
                    <select id="engine_boolean_conditioned_false_operator_parameter_${contextUuid}_${newConditionNumber}" class="js-example-basic-single" style="width:100%;margin-bottom:7px" onchange="setEngineBooleanConditionatedFalseConditionValueConfig('${contextUuid}',${newConditionNumber})" ${disabled}>
                        <option value="equal" ${selectedEqual} > (=) Equal</option>
                        <option value="different" ${selectedDifferent} > (!=) Different</option>
                        <option value="less_than" ${selectedLessThan} > (<) Less than</option>
                        <option value="greater_than" ${selectedGreaterThan} > (>) Greater than</option>
                    </select>                        
                    <input id='engine_boolean_conditioned_false_second_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.second_parameter}' oninput="setEngineBooleanConditionatedFalseConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Value' ${disabled} />
                    <label id='engine_boolean_conditioned_false_second_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
                </div>
            </span>            
        `
        conditionsContainer.insertAdjacentHTML('afterbegin',html)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditioned_false_first_parameter_${contextUuid}_${newConditionNumber}`,app.md.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditioned_false_second_parameter_${contextUuid}_${newConditionNumber}`,app.md.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
    }

    function addEngineBooleanConditionedOrTrueCondition(contextUuid,condition=JSON.parse(JSON.stringify(app.md.flag_form.engineBooleanConditionedCondition)) ){

        let disabled='disabled="disabled"'
        if (app.md.flag_form.userHasPermissionOnElement(app.md.flag_form.userPermissions,[app.md.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }

        //app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions
          
        let conditionsContainer = document.getElementById(`boolean_conditionedor_true_conditions_${contextUuid}`)
        let newConditionNumber = conditionsContainer.childElementCount

        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_true.conditions[newConditionNumber]=condition

        let selectedEqual = ""
        let selectedDifferent = ""
        let selectedLessThan = ""
        let selectedGreaterThan = ""

        if (condition.operator_parameter==="equal") {
            selectedEqual="selected"
        } else if(condition.operator_parameter==="different") {
            selectedDifferent="selected"
        } else if(condition.operator_parameter==="less_than") {
            selectedLessThan="selected"
        } else if(condition.operator_parameter==="greater_than") {
            selectedGreaterThan="selected"
        }

        let html =`
        <span id="boolean_conditionor_true_${contextUuid}_${newConditionNumber}" class="card" style="margin-top:10px;box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2)">
            <div class="card-body">        
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteEngineBooleanConditionedOrTrueCondition('${contextUuid}',${newConditionNumber})" ${disabled}><i class="bi bi-dash-circle"></i></button> <label style='margin-bottom:7px;font-size:17px'>Condition #${newConditionNumber+1}</label>
                <input id='engine_boolean_conditionedor_true_first_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.first_parameter}' oninput="setEngineBooleanConditionatedOrTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Key' ${disabled} />
                <label id='engine_boolean_conditionedor_true_first_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
                <select id="engine_boolean_conditionedor_true_operator_parameter_${contextUuid}_${newConditionNumber}" class="js-example-basic-single" style="width:100%;margin-bottom:7px" onchange="setEngineBooleanConditionatedOrTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" ${disabled}>
                    <option value="equal" ${selectedEqual} > (=) Equal</option>
                    <option value="different" ${selectedDifferent} > (!=) Different</option>
                    <option value="less_than" ${selectedLessThan} > (<) Less than</option>
                    <option value="greater_than" ${selectedGreaterThan} > (>) Greater than</option>
                </select>                        
                <input id='engine_boolean_conditionedor_true_second_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.second_parameter}' oninput="setEngineBooleanConditionatedOrTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Value' ${disabled} />
                <label id='engine_boolean_conditionedor_true_second_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
            </div>
        </span>            
        `
        conditionsContainer.insertAdjacentHTML('afterbegin',html)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditionedor_true_first_parameter_${contextUuid}_${newConditionNumber}`,app.md.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditionedor_true_second_parameter_${contextUuid}_${newConditionNumber}`,app.md.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
    }

    function addEngineBooleanConditionedOrFalseCondition(contextUuid,condition=JSON.parse(JSON.stringify(app.md.flag_form.engineBooleanConditionedCondition)) ){

        let disabled='disabled="disabled"'
        if (app.md.flag_form.userHasPermissionOnElement(app.md.flag_form.userPermissions,[app.md.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }
          
        let conditionsContainer = document.getElementById(`boolean_conditionedor_false_conditions_${contextUuid}`)
        let newConditionNumber = conditionsContainer.childElementCount

        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_false.conditions[newConditionNumber]=condition

        let selectedEqual = ""
        let selectedDifferent = ""
        let selectedLessThan = ""
        let selectedGreaterThan = ""

        if (condition.operator_parameter==="equal") {
            selectedEqual="selected"
        } else if(condition.operator_parameter==="different") {
            selectedDifferent="selected"
        } else if(condition.operator_parameter==="less_than") {
            selectedLessThan="selected"
        } else if(condition.operator_parameter==="greater_than") {
            selectedGreaterThan="selected"
        }

        let html =`
        <span id="boolean_conditionor_false_${contextUuid}_${newConditionNumber}" class="card" style="margin-top:10px;box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2)">
            <div class="card-body">        
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteEngineBooleanConditionedOrFalseCondition('${contextUuid}',${newConditionNumber})" ${disabled}><i class="bi bi-dash-circle"></i></button> <label style='margin-bottom:7px;font-size:17px'>Condition #${newConditionNumber+1}</label>
                <input id='engine_boolean_conditionedor_false_first_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.first_parameter}' oninput="setEngineBooleanConditionatedOrFalseConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Key' ${disabled} />
                <label id='engine_boolean_conditionedor_false_first_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
                <select id="engine_boolean_conditionedor_false_operator_parameter_${contextUuid}_${newConditionNumber}" class="js-example-basic-single" style="width:100%;margin-bottom:7px" onchange="setEngineBooleanConditionatedOrFalseConditionValueConfig('${contextUuid}',${newConditionNumber})" ${disabled}>
                    <option value="equal" ${selectedEqual} > (=) Equal</option>
                    <option value="different" ${selectedDifferent} > (!=) Different</option>
                    <option value="less_than" ${selectedLessThan} > (<) Less than</option>
                    <option value="greater_than" ${selectedGreaterThan} > (>) Greater than</option>
                </select>                        
                <input id='engine_boolean_conditionedor_false_second_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.second_parameter}' oninput="setEngineBooleanConditionatedOrFalseConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Value' ${disabled} />
                <label id='engine_boolean_conditionedor_false_second_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
            </div>
        </span>            
        `
        conditionsContainer.insertAdjacentHTML('afterbegin',html)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditionedor_false_first_parameter_${contextUuid}_${newConditionNumber}`,app.md.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditionedor_false_second_parameter_${contextUuid}_${newConditionNumber}`,app.md.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
    }

    /**
     * Validation listener for both TRUE and FALSE boolean conditioned engines
     */
    function engineBooleanConditionedCondition_ValidationListener(conditionIndex,elementId,validateSchema){
        let element = document.getElementById(elementId)
        if(element.value===""){
            if(validateSchema.required){
                document.getElementById(`${elementId}_validation_message`).innerHTML=validateSchema.requiredMessage

            }
            else{
                document.getElementById(`${elementId}_validation_message`).innerHTML=""
            }               
        } else {
            regexpValidator = new RegExp(validateSchema.regexp)
            if(!regexpValidator.test(element.value)){
                document.getElementById(`${elementId}_validation_message`).innerHTML=validateSchema.message
            }
            else {
                document.getElementById(`${elementId}_validation_message`).innerHTML=""
            }
        }
    }     

    function deleteEngineBooleanConditionedTrueCondition(contextUuid,conditionIndex){
        document.getElementById(`boolean_conditioned_true_conditions_${contextUuid}`).removeChild(document.getElementById(`boolean_condition_true_${contextUuid}_${conditionIndex}`))
        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions.splice(conditionIndex, 1);
        setEngineView(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${contextUuid}`)].engine,contextUuid)
    }

    function deleteEngineBooleanConditionedFalseCondition(contextUuid,conditionIndex){
        document.getElementById(`boolean_conditioned_false_conditions_${contextUuid}`).removeChild(document.getElementById(`boolean_condition_false_${contextUuid}_${conditionIndex}`))
        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions.splice(conditionIndex, 1);
        setEngineView(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${contextUuid}`)].engine,contextUuid)
    }

    function deleteEngineBooleanConditionedOrTrueCondition(contextUuid,conditionIndex){
        document.getElementById(`boolean_conditionedor_true_conditions_${contextUuid}`).removeChild(document.getElementById(`boolean_conditionor_true_${contextUuid}_${conditionIndex}`))
        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_true.conditions.splice(conditionIndex, 1);
        setEngineView(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${contextUuid}`)].engine,contextUuid)
    }

    function deleteEngineBooleanConditionedOrFalseCondition(contextUuid,conditionIndex){
        document.getElementById(`boolean_conditionedor_false_conditions_${contextUuid}`).removeChild(document.getElementById(`boolean_conditionor_false_${contextUuid}_${conditionIndex}`))
        app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_false.conditions.splice(conditionIndex, 1);
        setEngineView(app.md.flag_form.flag.contexts[getFlagContextIndexByUuId(`${contextUuid}`)].engine,contextUuid)
    }    

</script>
<% if (!editing) { %>
    <h3>Create Flag</h3>
<% } else { %>
    <sl-alert variant="warning" open>
        <sl-icon slot="icon" name="exclamation-triangle"></sl-icon>
        <strong>Editing Flag</strong><br />
        <%= flag.name %>
      </sl-alert>

<% } %>
<sl-tab-group id="flag_form_tab_group">
    <sl-tab slot="nav" panel="general">General</sl-tab>
    <sl-tab slot="nav" panel="values">Context Values</sl-tab>

    <% if (editing && UserHasPermissionOnElement(userPermissions,[prefix+'.flag'],['write']) ) { %>
        <sl-tab slot="nav" panel="operations">Operations</sl-tab>
        
    <% } %>

    <sl-tab-panel name="general">
                
        <% let fieldsEnabled = false; if (UserHasPermissionOnElement(userPermissions,[prefix+'.flag'],['write'])) { fieldsEnabled = true }%>

        <%- flagFieldRender("flag","name",flag.name,flagMetadata.name,fieldsEnabled) %>
        <%- flagFieldRender("flag","description",flag.description,flagMetadata.description,fieldsEnabled) %>
        <label style='margin-bottom:7px;font-size:17px'>Tags</label>
        <select id="flag_tags" class="js-example-basic-single" name="state[]" multiple="multiple" style="width:100%" >
            <% tags.forEach(tag => { %>
                <option value="<%= tag.uuid %>" <% if(flag.tags.includes(tag.uuid)){ %> selected <% } %> ><%= tag.name %></option>
             
            <% }) %>
        </select>          
        <br>
        <br>
        Bucket Context Storage:<br>
        <br>
        <% let disabled="disabled='disabled'" %>        
        <% bucket.contexts.forEach(context => { %>

            <% if (UserHasPermissionOnElement(userPermissions,[prefix+'.flag'],['write'])) { disabled="" } else { let disabled="disabled='disabled'" }%>

            <div class="alert alert-light" role="alert">
                <% let checked=""; if (flagContextsUuids.includes(context.uuid)) checked="checked" %>
                <input id="bucket_context_visibility_<%= context.uuid %>" value="<%= context.uuid %>" class="form-check-input" type="checkbox" onchange="setFlagContextValueConfig('<%= context.uuid %>')" <%= checked %>  <%= disabled %> > <%= context.name %>
            </div>
        
        <% }) %>

    </sl-tab-panel>
    <sl-tab-panel id="contexts_values_config" name="values"></sl-tab-panel>

    <% if (editing && UserHasPermissionOnElement(userPermissions,[prefix+'.flag'],['write'])) { %>
        <sl-tab-panel name="operations">
            <sl-details summary="Delete">
                <label style='margin-bottom:7px;font-size:17px' style="text-align: justify;">
                    Afer deleting this Flag, the clients will NO longer receive It's configuration.
                    <br>
                    <br>
                </label>
                <button type="button" class="btn btn-outline-danger" onclick="app.confirmDelete('Delete Flag','Are you sure to delete the flag <strong><%= flag.name %></strong> ?','deleteFlag(`<%= flag.uuid %>`)')"><i class="bi bi-trash-fill"></i> Delete Flag</button>
                <br>
            </sl-details>
        </sl-tab-panel>
    <% } %>
    
</sl-tab-group>

<div slot="footer" style="padding: 20px;background-color: aliceblue;border-bottom-left-radius: 10px;border-bottom-right-radius: 10px;">
    <button type="button" class="btn btn-secondary" onclick="app.drawer.hide()">Close</button>
    <% if (UserHasPermissionOnElement(userPermissions,[prefix+'.flag'],['write'])) { %>
        <button type="button" class="btn btn-primary" onclick="submitFlag(this)">Save</sl-button>
    <% } %>
</div>

<script>
    addFlagContextsToList()
    $(document).ready(function() {
        $('.js-example-basic-single').select2({width:'resolve',placeholder: 'Select the tags you want.'});

        if (app.md.flag_form.bucket_context_uuid !=="") {  
            document.getElementById('flag_form_tab_group').show('values')
            document.getElementById(`bucket_context_value_config_${app.md.flag_form.bucket_context_uuid}`).show()
        } else {
            document.getElementById('flag_form_tab_group').show('general')
        }        
    });    
</script>