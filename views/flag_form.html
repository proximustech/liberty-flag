<script>
    app.module_data.flag_form={}
    app.module_data.flag_form.prefix=<%- JSON.stringify(prefix) %>
    app.module_data.flag_form.flag=JSON.parse(`<%- JSON.stringify(flag) %>`)
    app.module_data.flag_form.flagValidateSchema = JSON.parse(`<%- JSON.stringify(flagValidateSchema).replaceAll("\\","\\\\") %>`)
    eval(`<%- flagValidateFunction %>`)

    app.module_data.flag_form.userPermissions = JSON.parse(`<%- JSON.stringify(userPermissions) %>`)
    eval(`<%- userHasPermissionOnElement %>`)    

    app.module_data.flag_form.flagContext=JSON.parse(`<%- JSON.stringify(flagContext) %>`)
    //app.module_data.flag_form.engineBoolean=JSON.parse(`<%- //JSON.stringify(engineBoolean) %>`)

    app.module_data.flag_form.engineBooleanConditioned=JSON.parse(`<%- JSON.stringify(engineBooleanConditioned) %>`)
    app.module_data.flag_form.engineBooleanConditionedCondition=JSON.parse(`<%- JSON.stringify(engineBooleanConditionedCondition) %>`)
    app.module_data.flag_form.engineBooleanConditionedConditionValidateShema = JSON.parse(`<%- JSON.stringify(engineBooleanConditionedConditionValidateShema).replaceAll("\\","\\\\") %>`)    
    eval(`<%- engineBooleanConditionedConditionValidateFunction %>`)

    app.module_data.flag_form.bucket=JSON.parse(`<%- JSON.stringify(bucket) %>`)

    function submitFlag(triggerElement) {

        let tags=[]

        for(let i=0 ;i<document.getElementById("flag_tags").selectedOptions.length;i++){
            tags.push(document.getElementById("flag_tags").selectedOptions[i].value)
        }
        
        app.module_data.flag_form.flag.tags=tags

        let flag = app.module_data.flag_form.flag
        flag.name = flag.name.trim()
        let flagValidationResult = app.module_data.flag_form.flagValidateFunction(flag,app.module_data.flag_form.flagValidateSchema)

        let engineBooleanConditionedConditionsValidationResult = true
        for (let flagContextIndex = 0; flagContextIndex < flag.contexts.length; flagContextIndex++) {
            const flagContext = flag.contexts[flagContextIndex];
            if ('boolean_conditioned_true' in flagContext.engine_parameters){
                for (let conditionIndex = 0; conditionIndex < flagContext.engine_parameters.boolean_conditioned_true.conditions.length; conditionIndex++) {
                    const condition = flagContext.engine_parameters.boolean_conditioned_true.conditions[conditionIndex];
                    let engineBooleanConditionedConditionValidationResult = app.module_data.flag_form.engineBooleanConditionedConditionValidateFunction(condition,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema)
                    if (!engineBooleanConditionedConditionValidationResult.isValid) {
                        flagValidationResult.isValid = false
                        flagValidationResult.messages = flagValidationResult.messages.concat(engineBooleanConditionedConditionValidationResult.messages)
                        break
                    }
                    
                }
            }
            if ('boolean_conditioned_false' in flagContext.engine_parameters){
                for (let conditionIndex = 0; conditionIndex < flagContext.engine_parameters.boolean_conditioned_false.conditions.length; conditionIndex++) {
                    const condition = flagContext.engine_parameters.boolean_conditioned_false.conditions[conditionIndex];
                    let engineBooleanConditionedConditionValidationResult = app.module_data.flag_form.engineBooleanConditionedConditionValidateFunction(condition,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema)
                    if (!engineBooleanConditionedConditionValidationResult.isValid) {
                        flagValidationResult.isValid = false
                        flagValidationResult.messages = flagValidationResult.messages.concat(engineBooleanConditionedConditionValidationResult.messages)
                        break
                    }
                    
                } 
            }
            if ('boolean_conditionedor_true' in flagContext.engine_parameters){
                for (let conditionIndex = 0; conditionIndex < flagContext.engine_parameters.boolean_conditionedor_true.conditions.length; conditionIndex++) {
                    const condition = flagContext.engine_parameters.boolean_conditionedor_true.conditions[conditionIndex];
                    let engineBooleanConditionedConditionValidationResult = app.module_data.flag_form.engineBooleanConditionedConditionValidateFunction(condition,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema)
                    if (!engineBooleanConditionedConditionValidationResult.isValid) {
                        flagValidationResult.isValid = false
                        flagValidationResult.messages = flagValidationResult.messages.concat(engineBooleanConditionedConditionValidationResult.messages)
                        break
                    }
                    
                }
            }            
            
        }
       
        if (flagValidationResult.isValid) {
            app.setElementForPendingOperation(triggerElement)
            let result = $.ajax({
                type:"POST",
                url:"<%= prefix %>/flag",
                data:"json="+JSON.stringify(flag),
                processData: false,
                dataType:"text"
            })
            .done(function() {
                setTimeout(() => {
                    app.setViewForPendingOperation('content_view') 
                    htmx.ajax('GET', '/<%= prefix %>/flags?bucket_uuid=<%= bucket.uuid %>', {target:'#content_view', swap:'innerHTML'})
                    app.drawer.hide();
                    app.toastShow('Saved','Flag saved successfully.',{type:"info"})           
                    
                }, 1000);
            })
            .fail(function(data) {
                try {
                    app.unsetElementForPendingOperation(triggerElement)
                    for (messageData of JSON.parse(data.responseText).messages) {
                        app.toastShow('Form data Error',messageData.message,{type:"error"})
                        break;
                    }

                } catch (error) {}
            })
            .always(function() {
            });              
        } else {
            try {
                app.toastShow('Form data Error',flagValidationResult.messages[0].message,{closable:true,type:"error"})
            } catch (error) {}
        }

      
    }

    function deleteFlag(uuid) {
        let result = $.ajax({
            type:"DELETE",
            url:"<%= prefix %>/flag?uuid="+uuid,
        })
        .done(function() {      
            setTimeout(() =>{
                app.setViewForPendingOperation('content_view')
                htmx.ajax('GET', '/<%= prefix %>/flags?bucket_uuid=<%= bucket.uuid %>', {target:'#content_view', swap:'innerHTML'})
                app.drawer.hide();
                app.dialog.hide()
                app.toastShow('Deleted','Flag deleted successfully.',{type:"info"}) 
            },1000)   
        })
    
    }

    function getFlagContextIndexByUuId(contextUuid){
        found = false
        for (let index = 0; index < app.module_data.flag_form.flag.contexts.length; index++) {
            if( app.module_data.flag_form.flag.contexts[index].bucket_context_uuid===contextUuid){
                found = index
            }
        }
        return found
    }
    function getBucketContextByUuId(contextUuid){
        found = {}
        for (let index = 0; index < app.module_data.flag_form.bucket.contexts.length; index++) {
            if( app.module_data.flag_form.bucket.contexts[index].uuid===contextUuid){
                found = app.module_data.flag_form.bucket.contexts[index]
            }
        }
        return found
    }

    /**
     * Redraws ALL the contexts of the "Context Values Tab"
     */
    function addFlagContextsToList(){
        document.getElementById('contexts_values_config').innerHTML=""
        let counter = 0
        app.module_data.flag_form.flag.contexts.forEach(flagContext => {
            addFlagContextToList(getBucketContextByUuId(flagContext.bucket_context_uuid),counter)
            counter++
        });
    }

    /**
     * Renders a specific context in the "Context Values" Tab
     */
    function addFlagContextToList(bucketContext,counter) {
        let booleanIsSelected = ""
        let booleanConditionedTrueIsSelected = ""
        let booleanConditionedFalseIsSelected = ""
        let booleanConditionedOrTrueIsSelected = ""

        if (app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine==="boolean") {
            booleanIsSelected="selected"
        } else if(app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine==="boolean_conditioned_true") {
            booleanConditionedTrueIsSelected = "selected"
        } else if(app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine==="boolean_conditioned_false") {
            booleanConditionedFalseIsSelected = "selected"
        } else if(app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine==="boolean_conditionedor_true") {
            booleanConditionedOrTrueIsSelected = "selected"
        }

        let disabled = "disabled='disabled'"
        if (app.module_data.flag_form.userHasPermissionOnElement(app.module_data.flag_form.userPermissions,[app.module_data.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }

        document.getElementById('contexts_values_config').insertAdjacentHTML("beforeend",`
            <div id="context_${bucketContext.uuid}_wrapper" style="margin-bottom: 10px;">
                <sl-details id='bucket_context_value_config_${bucketContext.uuid}' summary="${bucketContext.name}">
                    <label style='margin-bottom:7px;font-size:17px'>Engine</label>
                    <select id="engine" class="js-example-basic-single" style="width:100%;margin-bottom:7px" onchange=";setEngineView(this.value,'${bucketContext.uuid}')" ${disabled}>
                        <option value="boolean" ${booleanIsSelected}>True/False</option>
                        <option value="boolean_conditioned_true" ${booleanConditionedTrueIsSelected} >True (AND OPERATOR)</option>
                        <option value="boolean_conditioned_false" ${booleanConditionedFalseIsSelected} >False (AND OPERATOR)</option>
                        <option value="boolean_conditionedor_true" ${booleanConditionedOrTrueIsSelected} >True (OR OPERATOR)</option>
                    </select> 
                    <div id="engine_container_${bucketContext.uuid}" style="padding:5px"></div>
                </sl-details>
            </div>
            `)
        setEngineView(app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(`${bucketContext.uuid}`)].engine,`${bucketContext.uuid}`)
    }

    /**
     * Set display context data inside the "Context Values Tab" and Sets the data inside the flag data structure
     */ 
    function setFlagContextValueConfig(contextUuid){
        bucketContext = {}
        app.module_data.flags_list.bucket.contexts.forEach(tempContext => {
            if (tempContext.uuid === contextUuid) {
                bucketContext = tempContext
            }

        });
        let isChecked = document.getElementById("bucket_context_visibility_"+contextUuid).checked

        if (isChecked) {
            let newFlagContext = JSON.parse(JSON.stringify(app.module_data.flag_form.flagContext))
            newFlagContext.bucket_context_uuid = contextUuid

            newFlagContext.engine="boolean"
            newFlagContext.engine_parameters.boolean={status:false}

            newFlagContext.engine_parameters.boolean_conditioned_true={conditions:[]}
            newFlagContext.engine_parameters.boolean_conditioned_false={conditions:[]}
            newFlagContext.engine_parameters.boolean_conditionedor_true={conditions:[]}

            app.module_data.flag_form.flag.contexts.push(newFlagContext)

            addFlagContextsToList()


        } else {
            //Remove flag context from the Values list
            app.module_data.flag_form.flag.contexts.splice(getFlagContextIndexByUuId(contextUuid), 1);
            document.getElementById('contexts_values_config').removeChild(
                document.getElementById(`context_${contextUuid}_wrapper`)
            )
            
        }

    }

    /**
     * Saves a condition (conditionedTrue engine) data inside the flag data structure and sets the listeners for validation
     */
    function setEngineBooleanConditionatedTrueConditionValueConfig(contextUuid,conditionNumber){
        
        let firstParameterElement=document.getElementById(`engine_boolean_conditioned_true_first_parameter_${contextUuid}_${conditionNumber}`)
        let secondParameterElement=document.getElementById(`engine_boolean_conditioned_true_second_parameter_${contextUuid}_${conditionNumber}`)
        let operatorParameterElement=document.getElementById(`engine_boolean_conditioned_true_operator_parameter_${contextUuid}_${conditionNumber}`)

        let condition = JSON.parse(JSON.stringify(app.module_data.flag_form.engineBooleanConditionedCondition))
        condition.first_parameter=firstParameterElement.value
        condition.second_parameter=secondParameterElement.value
        condition.operator_parameter=operatorParameterElement.value

        app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions[conditionNumber]=condition
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,firstParameterElement.id,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,secondParameterElement.id,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
        
    }

    /**
     * Saves a condition (conditionedFalse engine) data inside the flag data structure and sets the listeners for validation
     */    
    function setEngineBooleanConditionatedFalseConditionValueConfig(contextUuid,conditionNumber){
        
        let firstParameterElement=document.getElementById(`engine_boolean_conditioned_false_first_parameter_${contextUuid}_${conditionNumber}`)
        let secondParameterElement=document.getElementById(`engine_boolean_conditioned_false_second_parameter_${contextUuid}_${conditionNumber}`)
        let operatorParameterElement=document.getElementById(`engine_boolean_conditioned_false_operator_parameter_${contextUuid}_${conditionNumber}`)

        let condition = JSON.parse(JSON.stringify(app.module_data.flag_form.engineBooleanConditionedCondition))
        condition.first_parameter=firstParameterElement.value
        condition.second_parameter=secondParameterElement.value
        condition.operator_parameter=operatorParameterElement.value

        app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions[conditionNumber]=condition
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,firstParameterElement.id,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,secondParameterElement.id,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
        
    }   

    /**
     * Saves a condition (conditionedTrue (OR) engine) data inside the flag data structure and sets the listeners for validation
     */
    function setEngineBooleanConditionatedOrTrueConditionValueConfig(contextUuid,conditionNumber){
        
        let firstParameterElement=document.getElementById(`engine_boolean_conditionedor_true_first_parameter_${contextUuid}_${conditionNumber}`)
        let secondParameterElement=document.getElementById(`engine_boolean_conditionedor_true_second_parameter_${contextUuid}_${conditionNumber}`)
        let operatorParameterElement=document.getElementById(`engine_boolean_conditionedor_true_operator_parameter_${contextUuid}_${conditionNumber}`)

        let condition = JSON.parse(JSON.stringify(app.module_data.flag_form.engineBooleanConditionedCondition))
        condition.first_parameter=firstParameterElement.value
        condition.second_parameter=secondParameterElement.value
        condition.operator_parameter=operatorParameterElement.value

        app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_true.conditions[conditionNumber]=condition
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,firstParameterElement.id,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(conditionNumber,secondParameterElement.id,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
        
    } 

    /**
     * Renders the html template for the selected engine and updates the flag data structure
     */
    function setEngineView(engine,contextUuid){

        let disabled = "disabled='disabled'"
        if (app.module_data.flag_form.userHasPermissionOnElement(app.module_data.flag_form.userPermissions,[app.module_data.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }

        app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine=engine
        if (engine === "boolean") {

            let checked = ""
            if(app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean.status){
                checked = "checked"
            }
            document.getElementById('engine_container_'+contextUuid).innerHTML = `
            <div class="form-check form-switch">
                <label class="form-check-label" for="flexCheckChecked">
                    Boolean Status
                </label>
                <input class="form-check-input" type="checkbox" role="switch" style="font-size:large" ${checked} onchange="app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId('${contextUuid}')].engine_parameters.boolean={status:this.checked}" ${disabled}>
            </div>
            `
        } else if (engine === "boolean_conditioned_true" ) {
            document.getElementById('engine_container_'+contextUuid).innerHTML = `
                <button type="button" class="btn btn-outline-primary" style="width:100%" onclick="addEngineBooleanConditionedTrueCondition('${contextUuid}')" ${disabled}><i class="bi bi-plus-circle"></i> Add Condition</button>
                <div id='boolean_conditioned_true_conditions_${contextUuid}'></div>
            `  
            for (let index = 0; index < app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions.length; index++) {
                addEngineBooleanConditionedTrueCondition(contextUuid,app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions[index])
                
            }        
        }
        else if (engine === "boolean_conditioned_false" ) {
            document.getElementById('engine_container_'+contextUuid).innerHTML = `
                <button type="button" class="btn btn-outline-primary" style="width:100%" onclick="addEngineBooleanConditionedFalseCondition('${contextUuid}')" ${disabled}><i class="bi bi-plus-circle"></i> Add Condition</button>
                <div id='boolean_conditioned_false_conditions_${contextUuid}'></div>
            `  
            for (let index = 0; index < app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions.length; index++) {
                addEngineBooleanConditionedFalseCondition(contextUuid,app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions[index])
                
            }        
        } else if (engine === "boolean_conditionedor_true" ) {
            document.getElementById('engine_container_'+contextUuid).innerHTML = `
                <button type="button" class="btn btn-outline-primary" style="width:100%" onclick="addEngineBooleanConditionedOrTrueCondition('${contextUuid}')" ${disabled}><i class="bi bi-plus-circle"></i> Add Condition</button>
                <div id='boolean_conditionedor_true_conditions_${contextUuid}'></div>
            `  
            for (let index = 0; index < app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_true.conditions.length; index++) {
                addEngineBooleanConditionedOrTrueCondition(contextUuid,app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_true.conditions[index])
                
            }        
        }
    }

    function addEngineBooleanConditionedTrueCondition(contextUuid,condition=JSON.parse(JSON.stringify(app.module_data.flag_form.engineBooleanConditionedCondition)) ){

        let disabled='disabled="disabled"'
        if (app.module_data.flag_form.userHasPermissionOnElement(app.module_data.flag_form.userPermissions,[app.module_data.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }

        //app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions
          
        let conditionsContainer = document.getElementById(`boolean_conditioned_true_conditions_${contextUuid}`)
        let newConditionNumber = conditionsContainer.childElementCount

        app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions[newConditionNumber]=condition

        let selectedEqual = ""
        let selectedDifferent = ""
        let selectedLessThan = ""
        let selectedGreaterThan = ""

        if (condition.operator_parameter==="equal") {
            selectedEqual="selected"
        } else if(condition.operator_parameter==="different") {
            selectedDifferent="selected"
        } else if(condition.operator_parameter==="less_than") {
            selectedLessThan="selected"
        } else if(condition.operator_parameter==="greater_than") {
            selectedGreaterThan="selected"
        }

        let html =`
            <fieldset id="boolean_condition_true_${contextUuid}_${newConditionNumber}" style="margin-top:7px;padding:8px;border-style:solid;border-width:2px;border-radius:13px;border-color:lightblue">
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteEngineBooleanConditionedTrueCondition('${contextUuid}',${newConditionNumber})" ${disabled}><i class="bi bi-dash-circle"></i></button> <label style='margin-bottom:7px;font-size:17px'>Condition #${newConditionNumber+1}</label>
                <input id='engine_boolean_conditioned_true_first_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.first_parameter}' oninput="setEngineBooleanConditionatedTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Key' ${disabled} />
                <label id='engine_boolean_conditioned_true_first_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
                <select id="engine_boolean_conditioned_true_operator_parameter_${contextUuid}_${newConditionNumber}" class="js-example-basic-single" style="width:100%;margin-bottom:7px" onchange="setEngineBooleanConditionatedTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" ${disabled}>
                    <option value="equal" ${selectedEqual} > (=) Equal</option>
                    <option value="different" ${selectedDifferent} > (!=) Different</option>
                    <option value="less_than" ${selectedLessThan} > (<) Less than</option>
                    <option value="greater_than" ${selectedGreaterThan} > (>) Greater than</option>
                </select>                        
                <input id='engine_boolean_conditioned_true_second_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.second_parameter}' oninput="setEngineBooleanConditionatedTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Value' ${disabled} />
                <label id='engine_boolean_conditioned_true_second_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
            </fieldset>
        `
        conditionsContainer.insertAdjacentHTML('afterbegin',html)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditioned_true_first_parameter_${contextUuid}_${newConditionNumber}`,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditioned_true_second_parameter_${contextUuid}_${newConditionNumber}`,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
    }

    function addEngineBooleanConditionedFalseCondition(contextUuid,condition=JSON.parse(JSON.stringify(app.module_data.flag_form.engineBooleanConditionedCondition)) ){

        let disabled='disabled="disabled"'
        if (app.module_data.flag_form.userHasPermissionOnElement(app.module_data.flag_form.userPermissions,[app.module_data.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }

        //app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions
          
        let conditionsContainer = document.getElementById(`boolean_conditioned_false_conditions_${contextUuid}`)
        let newConditionNumber = conditionsContainer.childElementCount

        app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions[newConditionNumber]=condition

        let selectedEqual = ""
        let selectedDifferent = ""
        let selectedLessThan = ""
        let selectedGreaterThan = ""

        if (condition.operator_parameter==="equal") {
            selectedEqual="selected"
        } else if(condition.operator_parameter==="different") {
            selectedDifferent="selected"
        } else if(condition.operator_parameter==="less_than") {
            selectedLessThan="selected"
        } else if(condition.operator_parameter==="greater_than") {
            selectedGreaterThan="selected"
        }

        let html =`
            <fieldset id="boolean_condition_false_${contextUuid}_${newConditionNumber}" style="margin-top:7px;padding:8px;border-style:solid;border-width:2px;border-radius:13px;border-color:lightblue">
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteEngineBooleanConditionedFalseCondition('${contextUuid}',${newConditionNumber})" ${disabled}><i class="bi bi-dash-circle"></i></button> <label style='margin-bottom:7px;font-size:17px'>Condition #${newConditionNumber+1}</label>
                <input id='engine_boolean_conditioned_false_first_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.first_parameter}' oninput="setEngineBooleanConditionatedFalseConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Key' ${disabled} />
                <label id='engine_boolean_conditioned_false_first_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
                <select id="engine_boolean_conditioned_false_operator_parameter_${contextUuid}_${newConditionNumber}" class="js-example-basic-single" style="width:100%;margin-bottom:7px" onchange="setEngineBooleanConditionatedFalseConditionValueConfig('${contextUuid}',${newConditionNumber})" ${disabled}>
                    <option value="equal" ${selectedEqual} > (=) Equal</option>
                    <option value="different" ${selectedDifferent} > (!=) Different</option>
                    <option value="less_than" ${selectedLessThan} > (<) Less than</option>
                    <option value="greater_than" ${selectedGreaterThan} > (>) Greater than</option>
                </select>                        
                <input id='engine_boolean_conditioned_false_second_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.second_parameter}' oninput="setEngineBooleanConditionatedFalseConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Value' ${disabled} />
                <label id='engine_boolean_conditioned_false_second_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
            </fieldset>
        `
        conditionsContainer.insertAdjacentHTML('afterbegin',html)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditioned_false_first_parameter_${contextUuid}_${newConditionNumber}`,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditioned_false_second_parameter_${contextUuid}_${newConditionNumber}`,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
    }

    function addEngineBooleanConditionedOrTrueCondition(contextUuid,condition=JSON.parse(JSON.stringify(app.module_data.flag_form.engineBooleanConditionedCondition)) ){

        let disabled='disabled="disabled"'
        if (app.module_data.flag_form.userHasPermissionOnElement(app.module_data.flag_form.userPermissions,[app.module_data.flag_form.prefix+'.flag'],['write'])) {
            disabled=""
        }

        //app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions
          
        let conditionsContainer = document.getElementById(`boolean_conditionedor_true_conditions_${contextUuid}`)
        let newConditionNumber = conditionsContainer.childElementCount

        app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_true.conditions[newConditionNumber]=condition

        let selectedEqual = ""
        let selectedDifferent = ""
        let selectedLessThan = ""
        let selectedGreaterThan = ""

        if (condition.operator_parameter==="equal") {
            selectedEqual="selected"
        } else if(condition.operator_parameter==="different") {
            selectedDifferent="selected"
        } else if(condition.operator_parameter==="less_than") {
            selectedLessThan="selected"
        } else if(condition.operator_parameter==="greater_than") {
            selectedGreaterThan="selected"
        }

        let html =`
            <fieldset id="boolean_conditionor_true_${contextUuid}_${newConditionNumber}" style="margin-top:7px;padding:8px;border-style:solid;border-width:2px;border-radius:13px;border-color:lightblue">
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteEngineBooleanConditionedOrTrueCondition('${contextUuid}',${newConditionNumber})" ${disabled}><i class="bi bi-dash-circle"></i></button> <label style='margin-bottom:7px;font-size:17px'>Condition #${newConditionNumber+1}</label>
                <input id='engine_boolean_conditionedor_true_first_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.first_parameter}' oninput="setEngineBooleanConditionatedOrTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Key' ${disabled} />
                <label id='engine_boolean_conditionedor_true_first_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
                <select id="engine_boolean_conditionedor_true_operator_parameter_${contextUuid}_${newConditionNumber}" class="js-example-basic-single" style="width:100%;margin-bottom:7px" onchange="setEngineBooleanConditionatedOrTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" ${disabled}>
                    <option value="equal" ${selectedEqual} > (=) Equal</option>
                    <option value="different" ${selectedDifferent} > (!=) Different</option>
                    <option value="less_than" ${selectedLessThan} > (<) Less than</option>
                    <option value="greater_than" ${selectedGreaterThan} > (>) Greater than</option>
                </select>                        
                <input id='engine_boolean_conditionedor_true_second_parameter_${contextUuid}_${newConditionNumber}' class='form-control' style='margin-bottom:7px' type='text' value='${condition.second_parameter}' oninput="setEngineBooleanConditionatedOrTrueConditionValueConfig('${contextUuid}',${newConditionNumber})" placeholder='Value' ${disabled} />
                <label id='engine_boolean_conditionedor_true_second_parameter_${contextUuid}_${newConditionNumber}_validation_message' style='font-size:15px;color:red;margin-left:2px;margin-top:3px'></label>
            </fieldset>
        `
        conditionsContainer.insertAdjacentHTML('afterbegin',html)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditionedor_true_first_parameter_${contextUuid}_${newConditionNumber}`,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.first_parameter)
        engineBooleanConditionedCondition_ValidationListener(newConditionNumber,`engine_boolean_conditionedor_true_second_parameter_${contextUuid}_${newConditionNumber}`,app.module_data.flag_form.engineBooleanConditionedConditionValidateShema.second_parameter)
    }    

    /**
     * Validation listener for both TRUE and FALSE boolean conditioned engines
     */
    function engineBooleanConditionedCondition_ValidationListener(conditionIndex,elementId,validateSchema){
        let element = document.getElementById(elementId)
        if(element.value===""){
            if(validateSchema.required){
                document.getElementById(`${elementId}_validation_message`).innerHTML=validateSchema.requiredMessage

            }
            else{
                document.getElementById(`${elementId}_validation_message`).innerHTML=""
            }               
        } else {
            regexpValidator = new RegExp(validateSchema.regexp)
            if(!regexpValidator.test(element.value)){
                document.getElementById(`${elementId}_validation_message`).innerHTML=validateSchema.message
            }
            else {
                document.getElementById(`${elementId}_validation_message`).innerHTML=""
            }
        }
    }     

    function deleteEngineBooleanConditionedTrueCondition(contextUuid,conditionIndex){
        document.getElementById(`boolean_conditioned_true_conditions_${contextUuid}`).removeChild(document.getElementById(`boolean_condition_true_${contextUuid}_${conditionIndex}`))
        app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_true.conditions.splice(conditionIndex, 1);
        setEngineView(app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(`${contextUuid}`)].engine,contextUuid)
    }

    function deleteEngineBooleanConditionedFalseCondition(contextUuid,conditionIndex){
        document.getElementById(`boolean_conditioned_false_conditions_${contextUuid}`).removeChild(document.getElementById(`boolean_condition_false_${contextUuid}_${conditionIndex}`))
        app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditioned_false.conditions.splice(conditionIndex, 1);
        setEngineView(app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(`${contextUuid}`)].engine,contextUuid)
    }

    function deleteEngineBooleanConditionedOrTrueCondition(contextUuid,conditionIndex){
        document.getElementById(`boolean_conditionedor_true_conditions_${contextUuid}`).removeChild(document.getElementById(`boolean_conditionor_true_${contextUuid}_${conditionIndex}`))
        app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(contextUuid)].engine_parameters.boolean_conditionedor_true.conditions.splice(conditionIndex, 1);
        setEngineView(app.module_data.flag_form.flag.contexts[getFlagContextIndexByUuId(`${contextUuid}`)].engine,contextUuid)
    }    

</script>
<% if (!editing) { %>
    <h3>Create Flag</h3>
<% } else { %>
    <sl-alert variant="warning" open>
        <sl-icon slot="icon" name="exclamation-triangle"></sl-icon>
        <strong>Editing Flag</strong><br />
        <%= flag.name %>
      </sl-alert>

<% } %>
<sl-tab-group id="flag_form_tab_group">
    <sl-tab slot="nav" panel="general">General</sl-tab>
    <sl-tab slot="nav" panel="values">Context Values</sl-tab>

    <% if (editing && UserHasPermissionOnElement(userPermissions,[prefix+'.flag'],['write']) ) { %>
        <sl-tab slot="nav" panel="operations">Operations</sl-tab>
        
    <% } %>

    <sl-tab-panel name="general">
                
        <% let fieldsEnabled = false; if (UserHasPermissionOnElement(userPermissions,[prefix+'.flag'],['write'])) { fieldsEnabled = true }%>

        <%- flagFieldRender("flag","name",flag.name,flagMetadata.name,fieldsEnabled) %>
        <%- flagFieldRender("flag","description",flag.description,flagMetadata.description,fieldsEnabled) %>
        <label style='margin-bottom:7px;font-size:17px'>Tags</label>
        <select id="flag_tags" class="js-example-basic-single" name="state[]" multiple="multiple" style="width:100%" >
            <% tags.forEach(tag => { %>
                <option value="<%= tag.uuid %>" <% if(flag.tags.includes(tag.uuid)){ %> selected <% } %> ><%= tag.name %></option>
             
            <% }) %>
        </select>          
        <br>
        <br>
        Bucket Context Storage:<br>
        <br>
        <% let disabled="disabled='disabled'" %>        
        <% bucket.contexts.forEach(context => { %>

            <% if (UserHasPermissionOnElement(userPermissions,[prefix+'.flag'],['write'])) { disabled="" } else { let disabled="disabled='disabled'" }%>

            <div class="alert alert-light" role="alert">
                <% let checked=""; if (flagContextsUuids.includes(context.uuid)) checked="checked" %>
                <input id="bucket_context_visibility_<%= context.uuid %>" value="<%= context.uuid %>" class="form-check-input" type="checkbox" onchange="setFlagContextValueConfig('<%= context.uuid %>')" <%= checked %>  <%= disabled %> > <%= context.name %>
            </div>
        
        <% }) %>

    </sl-tab-panel>
    <sl-tab-panel id="contexts_values_config" name="values"></sl-tab-panel>

    <% if (editing && UserHasPermissionOnElement(userPermissions,[prefix+'.flag'],['write'])) { %>
        <sl-tab-panel name="operations">
            <sl-details summary="Delete">
                <label style='margin-bottom:7px;font-size:17px' style="text-align: justify;">
                    Afer deleting this Flag, the clients will NO longer receive It's configuration.
                    <br>
                    <br>
                </label>
                <button type="button" class="btn btn-outline-danger" onclick="app.confirmDelete('Delete Flag','Are you sure to delete the flag <strong><%= flag.name %></strong> ?','deleteFlag(`<%= flag.uuid %>`)')"><i class="bi bi-trash-fill"></i> Delete Flag</button>
                <br>
            </sl-details>
        </sl-tab-panel>
    <% } %>
    
</sl-tab-group>

<div slot="footer" style="padding: 20px;background-color: aliceblue;border-bottom-left-radius: 10px;border-bottom-right-radius: 10px;">
    <button type="button" class="btn btn-secondary" onclick="app.drawer.hide()">Close</button>
    <% if (UserHasPermissionOnElement(userPermissions,[prefix+'.flag'],['write'])) { %>
        <button type="button" class="btn btn-primary" onclick="submitFlag(this)">Save</sl-button>
    <% } %>
</div>

<script>
    document.getElementById('flag_form_tab_group').show('general')
    addFlagContextsToList()
    $(document).ready(function() {
        $('.js-example-basic-single').select2({width:'resolve',placeholder: 'Select the tags you want.'});
    });    
</script>